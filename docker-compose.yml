version: "3.8"

services:
  hive:
    build: .
    container_name: hive
    restart: unless-stopped
    ports:
      - "3100:3100"
    environment:
      - PORT=3100
      - HOST=0.0.0.0
      - PGHOST=${PGHOST}
      - PGPORT=${PGPORT:-5432}
      - PGUSER=${PGUSER}
      - PGPASSWORD=${PGPASSWORD}
      - PGDATABASE_TEAM=${PGDATABASE_TEAM}
      - MAILBOX_TOKEN_DOMINGO=${MAILBOX_TOKEN_DOMINGO}
      - MAILBOX_TOKEN_CLIO=${MAILBOX_TOKEN_CLIO}
      - MAILBOX_TOKEN_ZUMIE=${MAILBOX_TOKEN_ZUMIE}
      - MAILBOX_TOKEN_CHRIS=${MAILBOX_TOKEN_CHRIS}
      - MAILBOX_ADMIN_TOKEN=${MAILBOX_ADMIN_TOKEN}
      - UI_MAILBOX_KEYS=${UI_MAILBOX_KEYS:-SET_ME}
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      # Service
      - "traefik.http.services.hive.loadbalancer.server.port=3100"
      # Router 1: /ui paths
      - "traefik.http.routers.hive-ui.rule=Host(`c2.biginformatics.net`) && PathPrefix(`/ui`)"
      - "traefik.http.routers.hive-ui.entrypoints=websecure"
      - "traefik.http.routers.hive-ui.tls.certresolver=step-ca"
      - "traefik.http.routers.hive-ui.service=hive"
      - "traefik.http.routers.hive-ui.priority=100"
      # Router 2: /api paths
      - "traefik.http.routers.hive-route.rule=Host(`c2.biginformatics.net`) && PathPrefix(`/api`)"
      - "traefik.http.routers.hive-route.entrypoints=websecure"
      - "traefik.http.routers.hive-route.tls.certresolver=step-ca"
      - "traefik.http.routers.hive-route.service=hive"
      - "traefik.http.routers.hive-route.priority=100"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3100/healthz"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

networks:
  dokploy-network:
    external: true
