services:
  hive:
    build: .
    container_name: hive
    restart: unless-stopped
    ports:
      - "3100:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOST=0.0.0.0
      - PGHOST=${PGHOST:-data.biginformatics.net}
      - PGPORT=${PGPORT:-5432}
      - PGUSER=${PGUSER}
      - PGPASSWORD=${PGPASSWORD}
      - PGDATABASE_TEAM=${PGDATABASE_TEAM}
      - MAILBOX_TOKEN_DOMINGO=${MAILBOX_TOKEN_DOMINGO}
      - MAILBOX_TOKEN_CLIO=${MAILBOX_TOKEN_CLIO}
      - MAILBOX_TOKEN_ZUMIE=${MAILBOX_TOKEN_ZUMIE}
      - MAILBOX_TOKEN_CHRIS=${MAILBOX_TOKEN_CHRIS}
      - MAILBOX_ADMIN_TOKEN=${MAILBOX_ADMIN_TOKEN}
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      - "traefik.http.services.hive.loadbalancer.server.port=3000"
      # Main route â€” serves both UI and API
      - "traefik.http.routers.hive-route.rule=Host(`messages.biginformatics.net`)"
      - "traefik.http.routers.hive-route.entrypoints=websecure"
      - "traefik.http.routers.hive-route.tls.certresolver=letsencrypt"
      - "traefik.http.routers.hive-route.service=hive"
      # Legacy c2 route
      - "traefik.http.routers.hive-c2.rule=Host(`c2.biginformatics.net`)"
      - "traefik.http.routers.hive-c2.entrypoints=websecure"
      - "traefik.http.routers.hive-c2.tls.certresolver=step-ca"
      - "traefik.http.routers.hive-c2.service=hive"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

networks:
  dokploy-network:
    external: true
