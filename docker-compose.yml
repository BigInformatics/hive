version: "3.8"

services:
  mailbox-api:
    build: .
    container_name: mailbox-api
    restart: unless-stopped
    ports:
      - "3100:3100"
    environment:
      - PORT=3100
      - HOST=0.0.0.0
      - PGHOST=${PGHOST}
      - PGPORT=${PGPORT:-5432}
      - PGUSER=${PGUSER}
      - PGPASSWORD=${PGPASSWORD}
      - PGDATABASE_TEAM=${PGDATABASE_TEAM}
      - MAILBOX_TOKEN_DOMINGO=${MAILBOX_TOKEN_DOMINGO}
      - MAILBOX_TOKEN_CLIO=${MAILBOX_TOKEN_CLIO}
      - MAILBOX_TOKEN_ZUMIE=${MAILBOX_TOKEN_ZUMIE}
      - MAILBOX_TOKEN_CHRIS=${MAILBOX_TOKEN_CHRIS}
      - MAILBOX_ADMIN_TOKEN=${MAILBOX_ADMIN_TOKEN}
      - UI_MAILBOX_KEYS=${UI_MAILBOX_KEYS:-SET_ME}
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      # Service definition
      - "traefik.http.services.mailbox-svc.loadbalancer.server.port=3100"
      # Router for /ui (no prefix stripping)
      - "traefik.http.routers.mailbox-ui.rule=Host(`c2.biginformatics.net`) && PathPrefix(`/ui`)"
      - "traefik.http.routers.mailbox-ui.entrypoints=websecure"
      - "traefik.http.routers.mailbox-ui.tls=true"
      - "traefik.http.routers.mailbox-ui.tls.certresolver=step-ca"
      - "traefik.http.routers.mailbox-ui.service=mailbox-svc"
      # Router for /api (strip prefix)
      - "traefik.http.routers.mailbox-api.rule=Host(`c2.biginformatics.net`) && PathPrefix(`/api`)"
      - "traefik.http.routers.mailbox-api.entrypoints=websecure"
      - "traefik.http.routers.mailbox-api.tls=true"
      - "traefik.http.routers.mailbox-api.tls.certresolver=step-ca"
      - "traefik.http.routers.mailbox-api.service=mailbox-svc"
      - "traefik.http.routers.mailbox-api.middlewares=mailbox-strip"
      # Middleware to strip /api prefix
      - "traefik.http.middlewares.mailbox-strip.stripprefix.prefixes=/api"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3100/healthz"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

networks:
  dokploy-network:
    external: true
