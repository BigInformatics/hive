services:
  hive:
    build: .
    container_name: hive
    restart: unless-stopped
    expose:
      - "3000"
    volumes:
      - avatar-data:/app/public/avatars
      - attachment-data:/app/data/attachments
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOST=0.0.0.0
      - PGHOST=${PGHOST:-localhost}
      - PGPORT=${PGPORT:-5432}
      - PGUSER=${PGUSER}
      - PGPASSWORD=${PGPASSWORD}
      - PGDATABASE_TEAM=${PGDATABASE_TEAM}
      - SUPERUSER_TOKEN=${SUPERUSER_TOKEN}
      - SUPERUSER_NAME=${SUPERUSER_NAME}
      - SUPERUSER_DISPLAY_NAME=${SUPERUSER_DISPLAY_NAME:-}
      - HIVE_BASE_URL=${HIVE_BASE_URL:-http://localhost:3000}
      - ONEDEV_URL=${ONEDEV_URL:-}
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      - "traefik.http.services.hive.loadbalancer.server.port=3000"
      # Main route â€” serves both UI and API (high priority to override any stale routers)
      - "traefik.http.routers.hive-route.rule=Host(`messages.biginformatics.net`)"
      - "traefik.http.routers.hive-route.entrypoints=websecure"
      - "traefik.http.routers.hive-route.tls.certresolver=step-ca"
      - "traefik.http.routers.hive-route.service=hive"
      - "traefik.http.routers.hive-route.priority=200"
      # Legacy c2 route
      - "traefik.http.routers.hive-c2.rule=Host(`c2.biginformatics.net`)"
      - "traefik.http.routers.hive-c2.entrypoints=websecure"
      - "traefik.http.routers.hive-c2.tls.certresolver=step-ca"
      - "traefik.http.routers.hive-c2.service=hive"
      - "traefik.http.routers.hive-c2.priority=200"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

volumes:
  avatar-data:
  attachment-data:

networks:
  dokploy-network:
    external: true
